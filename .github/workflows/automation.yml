
name: QA Automation Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      ############################################################
      # Auto-discover a live UK HTTP proxy (no VPN needed)
      ############################################################
      
      - name: Discover working UK proxy (robust)
        id: get_proxy
        shell: bash
        run: |
          set -Eeuo pipefail

          echo "ðŸ”Ž Fetching UK proxy candidates from public sources..."
          workdir="$(mktemp -d)"
          raw="$workdir/raw.txt"
          candidates="$workdir/candidates.txt"

          # --- Sources (tolerate intermittent failures) ---
          # ProxyScrape (HTTP, GB)
          curl -fsSL 'https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=5000&country=gb&ssl=all&anonymity=all' \
            | tr -d '\r' >> "$raw" || true

          # proxy-list.download (HTTP, GB)
          curl -fsSL 'https://www.proxy-list.download/api/v1/get?type=http&country=GB' \
            | tr -d '\r' >> "$raw" || true

          # Geonode sample feed (HTTP, GB) â€“ may be rate-limited
          curl -fsSL 'https://proxylist.geonode.com/api/proxy-list?limit=200&page=1&sort_by=lastChecked&sort_type=desc&country=GB&protocols=http' \
            | jq -r '.data[]?.ip + ":" + (.data[]?.port|tostring)' >> "$raw" 2>/dev/null || true

          # Keep only IP:PORT lines (defensive)
          grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$' "$raw" | awk '!seen[$0]++' > "$workdir/all_ipports.txt" || true

          if [[ ! -s "$workdir/all_ipports.txt" ]]; then
            echo "âŒ No proxy candidates fetched. Public lists may be down. Re-run later." >&2
            exit 1
          fi

          # Prefer known working ports (avoid 80 unless necessary)
          awk -F: '($2 ~ /^(3128|8080|8000|8888|8118|1080|443)$/){print}' "$workdir/all_ipports.txt" > "$workdir/preferred.txt" || true
          awk -F: '($2 !~ /^(3128|8080|8000|8888|8118|1080|443)$/){print}' "$workdir/all_ipports.txt" > "$workdir/others.txt" || true
          cat "$workdir/preferred.txt" "$workdir/others.txt" | awk '!seen[$0]++' > "$workdir/ordered.txt"

          total=$(wc -l < "$workdir/ordered.txt" || echo 0)
          echo "âž¡ Candidates total (deduped): $total"

          if [[ "$total" -eq 0 ]]; then
            echo "âŒ Candidate list is empty after filtering." >&2
            exit 1
          fi

          # Build full URLs (http://IP:PORT)
          sed 's#^#http://#' "$workdir/ordered.txt" > "$candidates"

          # We will validate using an HTTP endpoint (no CONNECT needed).
          target='http://ip-api.com/json'

          # Probe in waves to avoid spending too much time on dead proxies.
          # First try top 75, then expand to 200 if needed.
          try_limit1=75
          try_limit2=200
          selected=""

          probe_batch () {
            local limit="$1"
            local i=0
            while IFS= read -r proxy; do
              i=$((i+1))
              [[ $i -gt $limit ]] && break
              echo "â†’ Trying $proxy"
              # Quick probe: 5s timeout, 1 retry
              if out="$(curl -x "$proxy" -m 5 --retry 1 -sS "$target" || true)"; then
                # Expect JSON with "country":"GB"
                if grep -q '"country"[[:space:]]*:[[:space:]]*"United Kingdom"' <<<"$out" || grep -q '"countryCode"[[:space:]]*:[[:space:]]*"GB"' <<<"$out"; then
                  echo "âœ… Working UK proxy found: $proxy"
                  selected="$proxy"
                  echo "$out"
                  return 0
                fi
              fi
            done < "$candidates"
            return 1
          }

          echo "ðŸ§ª Testing first $try_limit1 candidates..."
          if ! probe_batch "$try_limit1"; then
            echo "ðŸ” Expanding search to $try_limit2 candidates..."
            if ! probe_batch "$try_limit2"; then
              echo "âŒ No working UK proxy found right now. Free lists are volatile. Try re-running the job." >&2
              exit 1
            fi
          fi

          # Export for downstream steps
          echo "UK_PROXY=${selected}" >> "$GITHUB_ENV"
          echo "proxy=${selected}" >> "$GITHUB_OUTPUT"

        

      ############################################################
      # Playwright Tests
      ############################################################

      - name: Install Browsers
        run: npx playwright install --with-deps

      - name: Run tests
        id: run_tests
        run: npx playwright test --reporter=line

      ############################################################
      # Upload Test Artifacts
      ############################################################

      - name: Upload Playwright Artifacts
        id: upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            test-results/**
            playwright-report/**
          retention-days: 30

      ############################################################
      # Log results in Google Sheets
      ############################################################

      - name: Log results in Google Sheet
        env:
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

          PW_STATUS: ${{ job.status }}
          PW_NOTES: "Run finished"
          ARTIFACT_URL: ${{ steps.upload_artifacts.outputs.artifact-url }}

          DEVICE: "desktop"
          TEST_SUITE: "Full Regression"
          TRAFFIC_SOURCE: "organic"
          EVENTS_TRIGGERED: ""

        run: node scripts/update-google-sheet.js