
name: QA Automation Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      ############################################################
      # Connect to UK VPN (ExpressVPN)
      ############################################################

      - name: Install ExpressVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl

          # Download official installer (stable + maintained)
          curl -L https://www.expressvpn.com/clients/linux/expressvpn_install.sh -o expressvpn_install.sh
          chmod +x expressvpn_install.sh

          # Install ExpressVPN
          sudo bash expressvpn_install.sh

      - name: Activate ExpressVPN
        run: |
          echo "${{ secrets.EXPRESSVPN_ACTIVATION_CODE }}" | sudo expressvpn activate
          sudo expressvpn preferences set auto_connect true

      - name: Connect to UK
        run: sudo expressvpn connect "UK - Docklands"

      - name: Verify VPN
        run: |
          expressvpn status
          curl -s https://ipinfo.io

      ############################################################
      # Playwright Tests
      ############################################################

      - name: Install Browsers
        run: npx playwright install --with-deps

      - name: Run tests
        id: run_tests
        run: npx playwright test --reporter=line

      ############################################################
      # Upload Test Artifacts
      ############################################################

      - name: Upload Playwright Artifacts
        id: upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            test-results/**
            playwright-report/**
          retention-days: 30

      ############################################################
      # Log results in Google Sheets
      ############################################################

      - name: Log results in Google Sheet
        env:
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

          PW_STATUS: ${{ job.status }}
          PW_NOTES: "Run finished"
          ARTIFACT_URL: ${{ steps.upload_artifacts.outputs.artifact-url }}

          DEVICE: "desktop"
          TEST_SUITE: "Full Regression"
          TRAFFIC_SOURCE: "organic"
          EVENTS_TRIGGERED: ""

        run: node scripts/update-google-sheet.js
