
name: QA Automation Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      ############################################################
      # Auto-discover a live UK HTTP proxy (no VPN needed)
      ############################################################
      - name: Discover working UK proxy
        id: get_proxy
        shell: bash
        run: |
          set -Eeuo pipefail

          echo "ðŸ”Ž Fetching UK proxy candidates from public sources..."
          workdir="$(mktemp -d)"
          list="$workdir/proxies_raw.txt"

          # Source 1: ProxyScrape (HTTP, GB, <=4s timeout)
          curl -fsSL 'https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=4000&country=gb&ssl=all&anonymity=all' \
            | tr -d '\r' > "$list" || true

          # Source 2: proxy-list.download (HTTP, GB)
          # (Sometimes rate-limited; use '|| true' to keep going if it fails)
          curl -fsSL 'https://www.proxy-list.download/api/v1/get?type=http&country=GB' \
            | tr -d '\r' >> "$list" || true

          # Normalize -> add scheme, de-duplicate, keep non-empty
          awk 'NF' "$list" | sed 's#^#http://#' | awk '!seen[$0]++' > "$workdir/proxies.txt"

          echo "âž¡ Candidate count: $(wc -l < "$workdir/proxies.txt")"
          if [[ ! -s "$workdir/proxies.txt" ]]; then
            echo "âŒ Could not fetch any UK proxies." >&2
            exit 1
          fi

          echo "ðŸ§ª Testing up to 50 proxies for GB IP..."
          selected=""
          while IFS= read -r proxy; do
            echo "â†’ Trying $proxy"
            # Query ipinfo through the proxy with a short timeout
            if out="$(curl -x "$proxy" -m 6 -sS https://ipinfo.io/json || true)"; then
              if grep -q '"country": *"GB"' <<<"$out"; then
                echo "âœ… Working UK proxy found: $proxy"
                selected="$proxy"
                break
              fi
            fi
          done < <(head -n 50 "$workdir/proxies.txt")

          if [[ -z "${selected}" ]]; then
            echo "âŒ No working UK proxy found right now. Try re-running the job." >&2
            exit 1
          fi

          # Export for this job + set as a step output
          echo "UK_PROXY=${selected}" >> "$GITHUB_ENV"
          echo "proxy=${selected}" >> "$GITHUB_OUTPUT"

      - name: Verify UK IP (should show country GB)
        run: |
          echo "Proxy: $UK_PROXY"
          curl -x "$UK_PROXY" -s https://ipinfo.io
          echo
          echo "If the response above contains \"country\": \"GB\", we are good."

      ############################################################
      # Playwright Tests
      ############################################################

      - name: Install Browsers
        run: npx playwright install --with-deps

      - name: Run tests
        id: run_tests
        run: npx playwright test --reporter=line

      ############################################################
      # Upload Test Artifacts
      ############################################################

      - name: Upload Playwright Artifacts
        id: upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            test-results/**
            playwright-report/**
          retention-days: 30

      ############################################################
      # Log results in Google Sheets
      ############################################################

      - name: Log results in Google Sheet
        env:
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

          PW_STATUS: ${{ job.status }}
          PW_NOTES: "Run finished"
          ARTIFACT_URL: ${{ steps.upload_artifacts.outputs.artifact-url }}

          DEVICE: "desktop"
          TEST_SUITE: "Full Regression"
          TRAFFIC_SOURCE: "organic"
          EVENTS_TRIGGERED: ""

        run: node scripts/update-google-sheet.js